<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Inter",sans-serif;
      background:#0e1116;
      color:#e6e9ef;
    }

    button{
      font-family:inherit;
    }

    /* ===== HEADER ===== */
    header{
      padding:14px 16px;
      background:#151a21;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    header strong{
      font-size:16px;
    }

    /* ===== DASHBOARD ===== */
    #dashboardView{
      padding:16px;
    }

    .primary-btn{
      width:100%;
      padding:16px;
      font-size:18px;
      border:none;
      border-radius:14px;
      background:#4da3ff;
      color:white;
      cursor:pointer;
      margin-bottom:16px;
    }

    .state-box{
      background:rgba(255,255,255,.08);
      padding:12px;
      border-radius:12px;
      margin-bottom:16px;
      font-size:14px;
    }

    .section-title{
      font-size:13px;
      color:#9aa4b2;
      margin:18px 0 8px;
    }

    /* ===== MEMBERS ===== */
    #members{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }

    .member{
      background:rgba(255,255,255,.08);
      padding:10px;
      border-radius:10px;
      font-size:12px;
      text-align:center;
      cursor:pointer;
    }

    .member.offline{
      opacity:.4;
    }

    /* ===== BOTTOM ACTIONS ===== */
    .bottom-actions{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }

    .icon-btn{
      padding:14px 0;
      background:rgba(255,255,255,.1);
      border-radius:12px;
      text-align:center;
      font-size:18px;
      cursor:pointer;
    }

    /* ===== MAP VIEW ===== */
    #mapView{
      display:none;
      height:100vh;
      width:100vw;
      position:relative;
    }

    #map{
      height:100%;
      width:100%;
    }

    #closeMap{
      position:absolute;
      top:14px;
      left:14px;
      z-index:1000;
      background:#151a21;
      color:white;
      border:none;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>
  <strong>Esem√©ny</strong>
</header>

<!-- ================= DASHBOARD ================= -->
<div id="dashboardView">

 <button class="primary-btn" id="startBtn">
  ‚ñ∂Ô∏è M√©r√©s ind√≠t√°sa
</button>


  <div class="state-box">
    Aktu√°lis √°llapot: <strong>Automatikus</strong><br/>
    Kontextus: ‚Äî
  </div>

  <div class="section-title">Tagok</div>
  <div id="members"></div>

  <div class="bottom-actions">
    <div class="icon-btn" onclick="showMap()">üó∫Ô∏è</div>
    <div class="icon-btn">üìä</div>
    <div class="icon-btn" onclick="goHome()">‚¨ÖÔ∏è</div>
  </div>

</div>

<!-- ================= MAP ================= -->
<div id="mapView">
  <button id="closeMap" onclick="showDashboard()">‚¨ÖÔ∏è Vissza</button>
  <div id="map"></div>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");
  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName") || "Ismeretlen";
  /* ================= MEASUREMENT STATE ================= */
let measurementActive = false;
let measurementStartedAt = null;


  if (!eventId || !userId) {
    location.href = "../index.html";
  }

  /* ===== VIEW SWITCH ===== */
  const dashboardView = document.getElementById("dashboardView");
  const mapView = document.getElementById("mapView");

  window.showMap = () => {
    dashboardView.style.display = "none";
    mapView.style.display = "block";
    map.invalidateSize();
  };

  window.showDashboard = () => {
    mapView.style.display = "none";
    dashboardView.style.display = "block";
  };

  window.goHome = () => location.href = "../index.html";
/* ================= START / STOP BUTTON ================= */
const startBtn = document.getElementById("startBtn");

function updateStartButton() {
  if (measurementActive) {
    startBtn.textContent = "‚èπÔ∏è M√©r√©s le√°ll√≠t√°sa";
    startBtn.style.background = "#e74c3c";
  } else {
    startBtn.textContent = "‚ñ∂Ô∏è M√©r√©s ind√≠t√°sa";
    startBtn.style.background = "#4da3ff";
  }
}

startBtn.onclick = () => {
  measurementActive = !measurementActive;

  if (measurementActive) {
    measurementStartedAt = Date.now();
    console.log("‚ñ∂Ô∏è M√©r√©si session indult");
  } else {
    console.log("‚èπÔ∏è M√©r√©si session le√°llt");
  }

  updateStartButton();
};

  /* ===== MAP ===== */
  const map = L.map("map");
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(map);

  let firstFix = true;
  let selfMarker = null;
  const markers = {};

  function markerIcon(color){
    return L.divIcon({
      className:"",
      html:`<div style="width:14px;height:14px;border-radius:50%;
        background:${color};border:2px solid white;"></div>`,
      iconSize:[14,14],
      iconAnchor:[7,7]
    });
  }

  function updateMarker(id, lat, lng, name){
    if(markers[id]){
      markers[id].setLatLng([lat,lng]);
    }else{
      markers[id] = L.marker([lat,lng],{
        icon:markerIcon("#4da3ff")
      }).addTo(map).bindPopup(name);
    }
  }

  /* ===== GPS ===== */
  navigator.geolocation.watchPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    const now = Date.now();

    if(firstFix){
      map.setView([latitude, longitude], 15);
      firstFix = false;
    }

    if(!selfMarker){
      selfMarker = L.marker([latitude, longitude],{
        icon:markerIcon("#2ecc71")
      }).addTo(map).bindPopup("Te");
    }else{
      selfMarker.setLatLng([latitude, longitude]);
    }

    update(ref(db, `members/${eventId}/${userId}`), {
      name: userName,
      lat: latitude,
      lng: longitude,
      lastUpdate: now
    });
  });

  /* ===== MEMBERS ===== */
  const OFFLINE_TIMEOUT = 15 * 60 * 1000;

  onValue(ref(db, `members/${eventId}`), snap=>{
    const list = document.getElementById("members");
    list.innerHTML = "";

    const now = Date.now();
    const data = snap.val() || {};

    Object.entries(data).forEach(([id,m])=>{
      if(!m.lat || !m.lng) return;

      const offline =
        m.lastUpdate && now - m.lastUpdate > OFFLINE_TIMEOUT;

      updateMarker(id, m.lat, m.lng, m.name || "?");

      const div = document.createElement("div");
      div.className = "member" + (offline ? " offline" : "");
      div.innerHTML = `
        <div>${m.name || "?"}</div>
        <div style="opacity:.7;margin-top:4px">
          ${offline ? "Offline" : "Akt√≠v"}
        </div>
      `;

      div.onclick = () => {
        showMap();
        map.setView([m.lat, m.lng], 16);
        markers[id]?.openPopup();
      };

      list.appendChild(div);
    });
  });
</script>

</body>
</html>
