<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Inter",sans-serif;
      background:#0e1116;
      color:#e6e9ef;
    }

    button{
      font-family:inherit;
    }

    /* ===== HEADER ===== */
    header{
      padding:14px 16px;
      background:#151a21;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    header strong{
      font-size:16px;
    }

    /* ===== DASHBOARD ===== */
    #dashboardView{
      padding:16px;
    }

    .primary-btn{
      width:100%;
      padding:16px;
      font-size:18px;
      border:none;
      border-radius:14px;
      background:#4da3ff;
      color:white;
      cursor:pointer;
      margin-bottom:16px;
    }

    .state-box{
      background:rgba(255,255,255,.08);
      padding:12px;
      border-radius:12px;
      margin-bottom:16px;
      font-size:14px;
    }

    .section-title{
      font-size:13px;
      color:#9aa4b2;
      margin:18px 0 8px;
    }

    /* ===== MEMBERS ===== */
    #members{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }

    .member{
      background:rgba(255,255,255,.08);
      padding:10px;
      border-radius:10px;
      font-size:12px;
      text-align:center;
      cursor:pointer;
    }

    .member.offline{
      opacity:.4;
    }

    /* ===== BOTTOM ACTIONS ===== */
    .bottom-actions{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }

    .icon-btn{
      padding:14px 0;
      background:rgba(255,255,255,.1);
      border-radius:12px;
      text-align:center;
      font-size:18px;
      cursor:pointer;
    }

    /* ===== MAP VIEW ===== */
    #mapView{
      display:none;
      height:100vh;
      width:100vw;
      position:relative;
    }

    #map{
      height:100%;
      width:100%;
    }

    #closeMap{
      position:absolute;
      top:14px;
      left:14px;
      z-index:1000;
      background:#151a21;
      color:white;
      border:none;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>
  <strong>Esem√©ny</strong>
</header>

<!-- ================= DASHBOARD ================= -->
<div id="dashboardView">

 <button class="primary-btn" id="startBtn">
  ‚ñ∂Ô∏è M√©r√©s ind√≠t√°sa
</button>


  <div class="state-box">
  Aktu√°lis √°llapot: <strong id="activityLabel">‚Äî</strong><br/>
  Kontextus: ‚Äî
</div>


  <div class="section-title">Tagok</div>
  <div id="members"></div>

  <div class="bottom-actions">
    <div class="icon-btn" onclick="showMap()">üó∫Ô∏è</div>
    <div class="icon-btn" onclick="openStat()">üìä</div>
    <div class="icon-btn" onclick="goHome()">‚¨ÖÔ∏è</div>
  </div>

</div>

<!-- ================= MAP ================= -->
<div id="mapView">
  <button id="closeMap" onclick="showDashboard()">‚¨ÖÔ∏è Vissza</button>
  <div id="map"></div>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  /* ===== PARAMS ===== */
  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");

  if (!eventId) {
    alert("Hi√°nyz√≥ esem√©ny azonos√≠t√≥");
    location.href = "../index.html";
  }

  /* ===== AUTH ===== */
  const auth = getAuth();

  let userId = null;
  let userName = localStorage.getItem("userName") || "Ismeretlen";

  onAuthStateChanged(auth, user => {
    if (user) {
      userId = user.uid;
      console.log("MAP AUTH OK:", userId);

      initMapApp(); // ‚¨ÖÔ∏è CSAK ITT indul a teljes app
    } else {
      signInAnonymously(auth).catch(err => {
        console.error("Auth hiba:", err);
        alert("Bejelentkez√©si hiba");
      });
    }
  });

  /* ===== APP INIT (AUTH UT√ÅN) ===== */
  function initMapApp() {
    console.log("initMapApp elindult, userId =", userId);

    /* ===== MAP ===== */
    const map = L.map("map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18
    }).addTo(map);

    let firstFix = true;
    let selfMarker = null;
    const markers = {};

    function markerIcon(color){
      return L.divIcon({
        className:"",
        html:`<div style="width:14px;height:14px;border-radius:50%;
          background:${color};
          border:2px solid white;"></div>`,
        iconSize:[14,14],
        iconAnchor:[7,7]
      });
    }

    function updateMarker(id, lat, lng, name){
      if(markers[id]){
        markers[id].setLatLng([lat,lng]);
      } else {
        markers[id] = L.marker([lat,lng],{
          icon:markerIcon("#4da3ff")
        }).addTo(map).bindPopup(name);
      }
    }

    /* ===== GPS ===== */
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      const now = Date.now();

      if (firstFix) {
        map.setView([latitude, longitude], 15);
        firstFix = false;
      }

      if (!selfMarker) {
        selfMarker = L.marker([latitude, longitude], {
          icon: markerIcon("#2ecc71")
        }).addTo(map).bindPopup("Te");
      } else {
        selfMarker.setLatLng([latitude, longitude]);
      }

      update(ref(db, `members/${eventId}/${userId}`), {
        name: userName,
        lat: latitude,
        lng: longitude,
        lastUpdate: now
      });
    }, err => {
      console.warn("GPS hiba:", err);
    }, {
      enableHighAccuracy: true
    });

    /* ===== MEMBERS + MARKERS ===== */
    const OFFLINE_TIMEOUT = 15 * 60 * 1000;

    onValue(ref(db, `members/${eventId}`), snap => {
      const list = document.getElementById("members");
      if (!list) return;

      list.innerHTML = "";
      const now = Date.now();
      const data = snap.val() || {};

      Object.entries(data).forEach(([id, m]) => {
        if (!m.lat || !m.lng) return;

        const offline =
          m.lastUpdate && now - m.lastUpdate > OFFLINE_TIMEOUT;

        updateMarker(id, m.lat, m.lng, m.name || "?");

        const div = document.createElement("div");
        div.className = "member" + (offline ? " offline" : "");
        div.innerHTML = `
          <div>${m.name || "?"}</div>
          <div style="opacity:.7;margin-top:4px">
            ${offline ? "Offline" : "Akt√≠v"}
          </div>
        `;

        div.onclick = () => {
          if (typeof showMap === "function") {
            showMap();
            map.setView([m.lat, m.lng], 16);
            markers[id]?.openPopup();
          }
        };

        list.appendChild(div);
      });
    });
  }
</script>

  /* ================= MEASUREMENT STATE ================= */
let measurementActive = false;
let measurementStartedAt = null;


  if (!eventId || !userId) {
    location.href = "../index.html";
  }
/* ================= ACTIVITY STATE ================= */
let currentActivity = "idle"; // skiing | lift | rest | idle
let lastAltitude = null;
let lastActivityChange = Date.now();
let stillSince = null;
/* ================= STATS ================= */
let totalDistanceKm = 0;
let maxSpeedKmh = 0;

let skiingMs = 0;
let liftMs = 0;
let restMs = 0;

let lastGpsPoint = null;
let lastStatTimestamp = Date.now();

  /* ===== VIEW SWITCH ===== */
  const dashboardView = document.getElementById("dashboardView");
  const mapView = document.getElementById("mapView");

  window.showMap = () => {
    dashboardView.style.display = "none";
    mapView.style.display = "block";
    map.invalidateSize();
  };

  window.showDashboard = () => {
    mapView.style.display = "none";
    dashboardView.style.display = "block";
  };

  window.goHome = () => location.href = "../index.html";
/* ================= START / STOP BUTTON ================= */
const startBtn = document.getElementById("startBtn");

function updateStartButton() {
  if (measurementActive) {
    startBtn.textContent = "‚èπÔ∏è M√©r√©s le√°ll√≠t√°sa";
    startBtn.style.background = "#e74c3c";
  } else {
    startBtn.textContent = "‚ñ∂Ô∏è M√©r√©s ind√≠t√°sa";
    startBtn.style.background = "#4da3ff";
  }
}

startBtn.onclick = () => {
  measurementActive = !measurementActive;

  if (measurementActive) {
    measurementStartedAt = Date.now();
    console.log("‚ñ∂Ô∏è M√©r√©si session indult");
  } else {
    console.log("‚èπÔ∏è M√©r√©si session le√°llt");
  }

  updateStartButton();
};

  /* ===== MAP ===== */
  const map = L.map("map");
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(map);

  let firstFix = true;
  let selfMarker = null;
  const markers = {};

  function markerIcon(color){
    return L.divIcon({
      className:"",
      html:`<div style="width:14px;height:14px;border-radius:50%;
        background:${color};border:2px solid white;"></div>`,
      iconSize:[14,14],
      iconAnchor:[7,7]
    });
  }

  function updateMarker(id, lat, lng, name){
    if(markers[id]){
      markers[id].setLatLng([lat,lng]);
    }else{
      markers[id] = L.marker([lat,lng],{
        icon:markerIcon("#4da3ff")
      }).addTo(map).bindPopup(name);
    }
  }
  function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

/* ================= AUTO ACTIVITY DETECTION ================= */
function detectActivity({ altitude, speed }) {
  const now = Date.now();

  if (!measurementActive) {
    currentActivity = "idle";
    return;
  }

  // sebess√©g m/s ‚Üí km/h
  const speedKmh = speed != null ? speed * 3.6 : 0;

  if (speedKmh < 1) {
    if (!stillSince) stillSince = now;
    if (now - stillSince > 15 * 60 * 1000) {
      setActivity("rest");
    }
    return;
  } else {
    stillSince = null;
  }

  if (lastAltitude != null) {
    const deltaAlt = altitude - lastAltitude;

    if (deltaAlt < -2 && speedKmh > 5) {
      setActivity("skiing");
    } else if (deltaAlt > 2 && speedKmh < 15) {
      setActivity("lift");
    }
  }

  lastAltitude = altitude;
}

function setActivity(next) {
  if (currentActivity === next) return;

  const now = Date.now();
  const delta = now - lastActivityChange;

  // ‚è±Ô∏è id≈ë hozz√°ad√°sa az el≈ëz≈ë √°llapothoz
  if (measurementActive) {
    if (currentActivity === "skiing") skiingMs += delta;
    if (currentActivity === "lift") liftMs += delta;
    if (currentActivity === "rest") restMs += delta;
  }

  currentActivity = next;
  lastActivityChange = now;

  const label = document.getElementById("activityLabel");
if (label) {
  label.textContent = next;
}

  console.log("‚õ∑Ô∏è √Ållapot:", next);
}

  /* ===== GPS ===== */
  navigator.geolocation.watchPosition(pos=>{
  const {latitude, longitude, altitude, speed} = pos.coords;
  const now = Date.now();


    if(firstFix){
      map.setView([latitude, longitude], 15);
      firstFix = false;
    }

    if(!selfMarker){
      selfMarker = L.marker([latitude, longitude],{
        icon:markerIcon("#2ecc71")
      }).addTo(map).bindPopup("Te");
    }else{
      selfMarker.setLatLng([latitude, longitude]);
    }
detectActivity({ altitude, speed });
// üìè T√ÅVOLS√ÅG + SEBESS√âG (csak cs√∫sz√°skor)
if (measurementActive && currentActivity === "skiing") {
  if (lastGpsPoint) {
    const dKm = haversine(
      lastGpsPoint.lat,
      lastGpsPoint.lng,
      latitude,
      longitude
    );

    totalDistanceKm += dKm;

    if (speed != null) {
      const speedKmh = speed * 3.6;
      maxSpeedKmh = Math.max(maxSpeedKmh, speedKmh);
    }
  }
}

lastGpsPoint = {
  lat: latitude,
  lng: longitude,
  ts: now
};

    update(ref(db, `members/${eventId}/${userId}`), {
      name: userName,
      lat: latitude,
      lng: longitude,
      lastUpdate: now
    });
  });

  /* ===== MEMBERS ===== */
  const OFFLINE_TIMEOUT = 15 * 60 * 1000;

  onValue(ref(db, `members/${eventId}`), snap=>{
    const list = document.getElementById("members");
    list.innerHTML = "";

    const now = Date.now();
    const data = snap.val() || {};

    Object.entries(data).forEach(([id,m])=>{
      if(!m.lat || !m.lng) return;

      const offline =
        m.lastUpdate && now - m.lastUpdate > OFFLINE_TIMEOUT;

      updateMarker(id, m.lat, m.lng, m.name || "?");

      const div = document.createElement("div");
      div.className = "member" + (offline ? " offline" : "");
      div.innerHTML = `
        <div>${m.name || "?"}</div>
        <div style="opacity:.7;margin-top:4px">
          ${offline ? "Offline" : "Akt√≠v"}
        </div>
      `;

      div.onclick = () => {
        showMap();
        map.setView([m.lat, m.lng], 16);
        markers[id]?.openPopup();
      };

      list.appendChild(div);
    });
  });
  function formatTime(ms){
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;

  if (h > 0) return `${h}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  return `${m}:${s.toString().padStart(2,"0")}`;
}
  /* ===== STAT MODAL ===== */
const statModal = document.getElementById("statModal");

window.openStat = () => {
  const statEl = document.getElementById("statContent");

  const distanceKm = (distanceMeters / 1000).toFixed(2);
  const avgSpeed =
    skiTimeMs > 0
      ? ((distanceMeters / 1000) / (skiTimeMs / 3600000)).toFixed(1)
      : "‚Äî";

  statEl.innerHTML = `
    <div>üü¢ Cs√∫sz√°s: <strong>${formatTime(skiTimeMs)}</strong></div>
    <div>üîµ Felvon√≥: <strong>${formatTime(liftTimeMs)}</strong></div>
    <div>üü° Pihen≈ë: <strong>${formatTime(restTimeMs)}</strong></div>
    <hr style="margin:10px 0;border-color:#333">
    <div>üìè T√°vols√°g: <strong>${distanceKm} km</strong></div>
    <div>üöÄ √Åtlag seb.: <strong>${avgSpeed} km/h</strong></div>
    <div>‚ö° Max seb.: <strong>${maxSpeedKmh.toFixed(1)} km/h</strong></div>
  `;

  statModal.style.display = "flex";
};


window.closeStat = () => {
  statModal.style.display = "none";
};

</script>

<!-- ================= STAT MODAL ================= -->
<div id="statModal" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
">
  <div style="
    background:#151a21;
    color:#e6e9ef;
    padding:20px;
    border-radius:16px;
    width:90%;
    max-width:360px;
  ">
    <h3 style="margin-top:0">üìä Saj√°t stat</h3>

    <div id="statContent" style="font-size:14px;line-height:1.6"></div>

    <button onclick="closeStat()" style="
      margin-top:16px;
      width:100%;
      padding:12px;
      border:none;
      border-radius:12px;
      background:#4da3ff;
      color:white;
      font-size:15px;
      cursor:pointer;
    ">Bez√°r√°s</button>
  </div>
</div>

</body>
</html>
