<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Team Ski Tracker ‚Äì T√©rk√©p</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #000;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    .status {
      position: absolute;
      bottom: 92px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
      max-width: 90%;
    }

    .controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1000;
    }

    .controls button {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(255,255,255,0.95);
      white-space: nowrap;
    }

    .controls button.primary {
      background: #1f6f8b;
      color: white;
    }

    .controls button.danger {
      background: #444;
      color: white;
    }
  </style>
</head>

<body>

<div id="map"></div>
<div class="status" id="status">GPS ind√≠t√°sa‚Ä¶</div>

<div class="controls">
  <button id="restBtn">‚òï Pihen√©s / H√ºtte</button>
  <button id="offlineBtn" class="danger">üö´ Offline</button>
  <button id="autoBtn" class="primary">‚ñ∂Ô∏è Kezdj√ºk</button>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  import { ActivityEngine } from "../js/activityEngine.js";
  import { ActivityStateMachine, StateTypes } from "../js/stateMachine.js";
  import { OSMContext } from "../js/osmContext.js";

  // ---------- PARAM√âTEREK ----------
  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");

  if (!eventId) {
    alert("Hi√°nyz√≥ esem√©nyazonos√≠t√≥");
    throw new Error("Missing eventId");
  }

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName") || "Ismeretlen";

  if (!userId) {
    alert("Nincs user azonos√≠t√≥");
    throw new Error("Missing userId");
  }

  const statusEl = document.getElementById("status");
  const restBtn = document.getElementById("restBtn");
  const offlineBtn = document.getElementById("offlineBtn");
  const autoBtn = document.getElementById("autoBtn");

  // ---------- T√âRK√âP ----------
  const map = L.map("map").setView([47.4979, 19.0402], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  // ---------- MARKEREK ----------
  const markers = {};

  function upsertMarker(id, lat, lng, label) {
    if (markers[id]) {
      markers[id].setLatLng([lat, lng]).setPopupContent(label);
    } else {
      markers[id] = L.marker([lat, lng])
        .addTo(map)
        .bindPopup(label);
    }
  }

  // ---------- OSM CONTEXT ----------
  const osm = new OSMContext(eventId, { lat: 47.4979, lng: 19.0402 }, 6);
  statusEl.textContent = "S√≠p√°lya adatok bet√∂lt√©se‚Ä¶";
  await osm.init();

  // ---------- ACTIVITY + STATE ----------
  const activityEngine = new ActivityEngine();

  const stateMachine = new ActivityStateMachine(state => {
    let text = "Automatikus k√∂vet√©s akt√≠v";

    if (state.state === StateTypes.MANUAL_REST || state.state === StateTypes.MANUAL_HUT) {
      text = "Pihen√©s m√≥d ‚Äì automatikus visszat√©r√©s 15 perc m√∫lva";
    }

    if (state.state === StateTypes.MANUAL_OFFLINE) {
      text = "Offline m√≥d ‚Äì nem osztasz meg poz√≠ci√≥t";
    }

    statusEl.textContent = text;

    update(ref(db, `members/${eventId}/${userId}`), {
      trackingState: state.state,
      manualUntil: state.manualUntil || null
    });
  });

  restBtn.onclick = () => stateMachine.setManualRest();
  offlineBtn.onclick = () => stateMachine.setManualOffline();
  autoBtn.onclick = () => stateMachine.startAutomatic();

  // ---------- TAGOK FIGYEL√âSE ----------
  onValue(ref(db, `members/${eventId}`), snap => {
    const members = snap.val() || {};
    const bounds = [];

    Object.entries(members).forEach(([id, m]) => {
      if (!m.lat || !m.lng) return;
      const label = `<b>${m.name || "?"}</b><br>${m.activity || ""}`;
      upsertMarker(id, m.lat, m.lng, label);
      bounds.push([m.lat, m.lng]);
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [40, 40] });
    }
  });

  // ---------- GPS ----------
  function sendPosition(pos) {
    if (stateMachine.getState() === StateTypes.MANUAL_OFFLINE) return;

    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const speedKmh = (pos.coords.speed || 0) * 3.6;

    activityEngine.addPoint({
      lat,
      lng,
      speed: speedKmh,
      altitude: pos.coords.altitude,
      timestamp: Date.now()
    });

    stateMachine.onMovementDetected(speedKmh);

    let baseActivity = "rest";

    if (stateMachine.isAutomatic()) {
      const detected = activityEngine.detectActivity();
      if (detected) baseActivity = detected;
    }

    const ctx = osm.getContext(lat, lng, baseActivity);

    let label = "Pihen";
    if (baseActivity === "skiing") label = "Cs√∫szik";
    if (baseActivity === "lift") label = "Felvon√≥n";

    if (ctx?.name) label += ` ‚Äì ${ctx.name}`;

    update(ref(db, `members/${eventId}/${userId}`), {
      name: userName,
      lat,
      lng,
      speed: speedKmh,
      activity: label,
      lastUpdate: Date.now()
    });

    upsertMarker(userId, lat, lng, `<b>${userName}</b><br>${label}`);
    statusEl.textContent = label;
  }

  function gpsError(err) {
    console.error("GPS error:", err);
    statusEl.textContent = "GPS nem el√©rhet≈ë";
  }

  navigator.geolocation.watchPosition(sendPosition, gpsError, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 10000
  });
</script>

</body>
</html>
