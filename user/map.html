<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Team Ski Tracker ‚Äì Esem√©ny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #000;
      color: #fff;
    }

    /* ===== TOP BAR ===== */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #1f6f8b;
      display: flex;
      align-items: center;
      padding: 0 10px;
      z-index: 2000;
      gap: 8px;
    }

    .topbar button {
      background: white;
      color: #1f6f8b;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .event-title {
      flex: 1;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* ===== MAP ===== */
    #map {
      position: fixed;
      top: 56px;
      bottom: 140px;
      left: 0;
      right: 0;
    }

    /* ===== STATUS ===== */
    .status {
      position: fixed;
      bottom: 92px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 1500;
      text-align: center;
    }

    /* ===== CONTROLS ===== */
    .controls {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 1500;
    }

    .controls button {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      background: rgba(255,255,255,0.95);
      color: #000;
    }

    .controls .primary {
      background: #1f6f8b;
      color: white;
    }

    .controls .danger {
      background: #444;
      color: white;
    }

    /* ===== HOST PANEL ===== */
    .host-panel {
      position: fixed;
      right: 10px;
      top: 66px;
      background: rgba(0,0,0,0.85);
      border-radius: 10px;
      padding: 10px;
      z-index: 1600;
      display: none;
    }

    .host-panel button {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <button onclick="goHome()">‚¨Ö</button>
  <div class="event-title" id="eventTitle">Esem√©ny‚Ä¶</div>
  <button onclick="leaveEvent()">üö™ Kil√©p√©s</button>
</div>

<!-- HOST PANEL -->
<div class="host-panel" id="hostPanel">
  <button onclick="showQr()">üìé Megh√≠v√≥</button>
  <button onclick="endEvent()">üõë Lez√°r√°s</button>
  <button onclick="deleteEvent()">üóëÔ∏è T√∂rl√©s</button>
</div>

<div id="map"></div>
<div class="status" id="status">Poz√≠ci√≥ meghat√°roz√°sa‚Ä¶</div>

<div class="controls">
  <button id="restBtn">‚òï Pihen√©s</button>
  <button id="offlineBtn" class="danger">üö´ Offline</button>
  <button id="autoBtn" class="primary">‚ñ∂Ô∏è Automatikus</button>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import {
    ref,
    onValue,
    update,
    remove,
    get
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // --------- PARAMS ---------
  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName") || "Ismeretlen";

  if (!eventId || !userId) {
    alert("Hi√°nyz√≥ adat");
    location.href = "../index.html";
  }

  const statusEl = document.getElementById("status");
  const titleEl = document.getElementById("eventTitle");
  const hostPanel = document.getElementById("hostPanel");

  // --------- LOAD EVENT ---------
  const eventSnap = await get(ref(db, `events/${eventId}`));
  if (!eventSnap.exists()) {
    alert("Az esem√©ny nem l√©tezik");
    location.href = "../index.html";
  }

  const event = eventSnap.val();
  titleEl.textContent = event.name;

  const isOwner = event.ownerId === userId;
  if (isOwner) {
    hostPanel.style.display = "block";
  }

  // --------- MAP ---------
  const map = L.map("map").setView([47.5, 19.04], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(map);

  const markers = {};

  function updateMarker(id, lat, lng, label) {
    if (markers[id]) {
      markers[id].setLatLng([lat, lng]).setPopupContent(label);
    } else {
      markers[id] = L.marker([lat, lng]).addTo(map).bindPopup(label);
    }
  }

  // --------- MEMBERS ---------
  onValue(ref(db, `members/${eventId}`), snap => {
    const members = snap.val() || {};
    const bounds = [];

    Object.entries(members).forEach(([id, m]) => {
      if (!m.lat || !m.lng) return;
      updateMarker(id, m.lat, m.lng, `${m.name}<br>${m.activity || ""}`);
      bounds.push([m.lat, m.lng]);
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [40,40] });
  });

  // --------- GPS ---------
  navigator.geolocation.watchPosition(pos => {
    update(ref(db, `members/${eventId}/${userId}`), {
      name: userName,
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      lastUpdate: Date.now()
    });
    statusEl.textContent = "Poz√≠ci√≥ friss√≠tve";
  });

  // --------- ACTIONS ---------
  window.goHome = () => location.href = "../index.html";

  window.leaveEvent = async () => {
    if (!confirm("Kil√©psz az esem√©nyb≈ël?")) return;
    await remove(ref(db, `members/${eventId}/${userId}`));
    goHome();
  };

  window.endEvent = async () => {
    if (!confirm("Lez√°rod az esem√©nyt?")) return;
    await update(ref(db, `events/${eventId}`), { status: "ended" });
    alert("Esem√©ny lez√°rva");
  };

  window.deleteEvent = async () => {
    if (!confirm("V√âGLEG t√∂rl√∂d az esem√©nyt?")) return;
    await remove(ref(db, `events/${eventId}`));
    await remove(ref(db, `members/${eventId}`));
    goHome();
  };

  window.showQr = () => {
    const url = `${location.origin}/team-ski-tracker/user/join.html?eventId=${eventId}`;
    prompt("Megh√≠v√≥ link:", url);
  };
</script>

</body>
</html>
