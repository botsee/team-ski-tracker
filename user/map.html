<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    #sidebar {
      width: 300px;
      background: #1f6f8b;
      color: white;
      padding: 14px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #sidebar h2 {
      margin-top: 0;
    }

    .menu-btn {
      width: 100%;
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }

    .section {
      margin-top: 18px;
    }

    .member {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.15);
      cursor: pointer;
    }

    .member:hover {
      background: rgba(255,255,255,0.12);
    }

    .left {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .time {
      font-size: 12px;
      opacity: 0.8;
    }

    #map {
      flex: 1;
    }
  </style>
</head>

<body>

<div id="app">

  <div id="sidebar">
    <h2 id="eventName">Esem√©ny</h2>

    <button class="menu-btn" onclick="goHome()">‚¨ÖÔ∏è Vissza</button>

    <div class="section">
      <strong>Saj√°t √°llapot</strong>
      <button class="menu-btn" onclick="setState('skiing')">üü¢ Cs√∫szok</button>
      <button class="menu-btn" onclick="setState('lift')">üîµ Felvon√≥n</button>
      <button class="menu-btn" onclick="setState('rest')">üü° Pihen / H√ºtte</button>
      <button class="menu-btn" onclick="setState('offline')">‚ö™ Offline</button>
    </div>

    <div class="section">
      <strong>Tagok</strong>
      <div id="members"></div>
    </div>
  </div>

  <div id="map"></div>

</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { OSMContext } from "../js/osmContext.js";

  const OFFLINE_TIMEOUT = 15 * 60 * 1000;

  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");
  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName") || "Ismeretlen";

  if (!eventId || !userId) {
    location.href = "../index.html";
  }

  /* MAP ‚Äì nincs fix kezd≈ëpont */
  const map = L.map("map");
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(map);

  let firstFix = true;
  let selfMarker = null;
  const markers = {};

  function markerColor(state, isOffline) {
    if (isOffline) return "#999";
    if (state === "skiing") return "#2ecc71";
    if (state === "lift") return "#3498db";
    if (state === "rest") return "#f1c40f";
    return "#1f6f8b";
  }

  function getMarkerIcon(state, isOffline) {
    return L.divIcon({
      className: "marker",
      html: `<div style="
        width:14px;
        height:14px;
        border-radius:50%;
        background:${markerColor(state, isOffline)};
        opacity:${isOffline ? 0.5 : 1};
        border:2px solid white;
      "></div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });
  }

  function updateMarker(id, lat, lng, label, state, isOffline) {
    if (markers[id]) {
      markers[id]
        .setLatLng([lat, lng])
        .setIcon(getMarkerIcon(state, isOffline))
        .setPopupContent(label);
    } else {
      markers[id] = L.marker([lat, lng], {
        icon: getMarkerIcon(state, isOffline)
      })
        .addTo(map)
        .bindPopup(label);
    }
  }

  /* EVENT */
  let osm = null;

  onValue(ref(db, `events/${eventId}`), async snap => {
    if (!snap.exists()) return;

    const event = snap.val();
    document.getElementById("eventName").textContent = event.name;

    if (!osm && event.resortCenter) {
      osm = new OSMContext(
        eventId,
        event.resortCenter,
        event.resortRadiusKm || 5
      );
      await osm.init();
    }
  });

  /* GPS ‚Äì EZ A KULCS */
  navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      if (firstFix) {
        map.setView([lat, lng], 15, { animate: true });
        firstFix = false;
      }

      if (!selfMarker) {
        selfMarker = L.marker([lat, lng])
          .addTo(map)
          .bindPopup("Te itt vagy");
      } else {
        selfMarker.setLatLng([lat, lng]);
      }

      update(ref(db, `members/${eventId}/${userId}`), {
        name: userName,
        lat,
        lng,
        lastUpdate: Date.now()
      });
    },
    err => console.warn("GPS hiba", err),
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    }
  );

  /* MEMBERS */
  onValue(ref(db, `members/${eventId}`), snap => {
    const list = document.getElementById("members");
    list.innerHTML = "";

    const now = Date.now();
    const members = snap.val() || {};

    Object.entries(members).forEach(([id, m]) => {
      if (!m.lat || !m.lng) return;

      const autoOffline =
        m.lastUpdate && now - m.lastUpdate > OFFLINE_TIMEOUT;
      const isOffline =
        m.manualState === "offline" || autoOffline;

      const state = m.activityState || "rest";

      let ctxName = "";
      if (!isOffline && osm) {
        const ctx = osm.getContext(m.lat, m.lng, state);
        if (ctx?.name) ctxName = ` ‚Äì ${ctx.name}`;
      }

      const label =
        isOffline
          ? "‚ö™ Offline"
          : state === "skiing"
          ? `üü¢ Cs√∫szik${ctxName}`
          : state === "lift"
          ? `üîµ Felvon√≥n${ctxName}`
          : `üü° Pihen${ctxName}`;

      const icon =
        isOffline ? "‚ö™" :
        state === "skiing" ? "üü¢" :
        state === "lift" ? "üîµ" :
        "üü°";

      const div = document.createElement("div");
      div.className = "member";
      div.innerHTML = `
        <div class="left">${icon} ${m.name || "?"}</div>
        <div class="time">${timeAgo(m.lastUpdate)}</div>
      `;
      div.onclick = () => {
        map.setView([m.lat, m.lng], 16, { animate: true });
        markers[id]?.openPopup();
      };
      list.appendChild(div);

      updateMarker(
        id,
        m.lat,
        m.lng,
        `<strong>${m.name}</strong><br>${label}`,
        state,
        isOffline
      );
    });
  });

  function timeAgo(ts) {
    if (!ts) return "";
    const min = Math.floor((Date.now() - ts) / 60000);
    if (min < 1) return "most";
    if (min === 1) return "1 perce";
    return `${min} perce`;
  }

  /* ACTIONS */
  window.goHome = () => location.href = "../index.html";

  window.setState = state =>
    update(ref(db, `members/${eventId}/${userId}`), {
      activityState: state,
      manualState: state === "offline" ? "offline" : null,
      lastUpdate: Date.now()
    });
</script>

</body>
</html>
