<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #app { display: flex; height: 100vh; width: 100vw; }

    #sidebar {
      width: 300px;
      background: #1f6f8b;
      color: white;
      padding: 14px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #sidebar h2 { margin-top: 0; }

    .menu-btn {
      width: 100%;
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
    }

    .section { margin-top: 18px; }

    .member {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.15);
      cursor: pointer;
    }

    .member:hover {
      background: rgba(255,255,255,0.12);
    }

    .left {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .time {
      font-size: 12px;
      opacity: 0.8;
    }

    #map { flex: 1; }
  </style>
</head>

<body>

<div id="app">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2 id="eventName">Esem√©ny</h2>

    <button class="menu-btn" onclick="goHome()">‚¨ÖÔ∏è Vissza</button>

    <div class="section">
      <strong>Saj√°t √°llapot</strong>
      <button class="menu-btn" onclick="setState('skiing')">üü¢ Cs√∫szok</button>
      <button class="menu-btn" onclick="setState('rest')">üü° Pihen / H√ºtte</button>
      <button class="menu-btn" onclick="setState('offline')">‚ö™ Offline</button>
    </div>

    <div class="section">
      <strong>Stat</strong>
      <div id="stats">‚Äì</div>
    </div>

    <div class="section">
      <strong>T√©rk√©p</strong>
      <button class="menu-btn" onclick="togglePistes()">üéø P√°ly√°k</button>
    </div>

    <div class="section">
      <strong>Tagok</strong>
      <div id="members"></div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map"></div>

</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { OSMContext } from "../js/osmContext.js";
  import { PisteLayer } from "../js/pisteLayer.js";
  import { StatsEngine } from "../js/statsEngine.js";

  const OFFLINE_TIMEOUT = 15 * 60 * 1000;
  const stats = new StatsEngine();

  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");
  const userId = localStorage.getItem("userId");

  if (!eventId || !userId) location.href = "../index.html";

  /* MAP */
  const map = L.map("map").setView([47.5, 19.04], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
  }).addTo(map);

  const markers = {};
  let osm = null;
  let pisteLayer = null;

  function markerColor(state, isOffline) {
    if (isOffline) return "#999";
    if (state === "skiing") return "#2ecc71";
    if (state === "rest") return "#f1c40f";
    return "#1f6f8b";
  }

  function getMarkerIcon(state, isOffline) {
    return L.divIcon({
      className: "marker",
      html: `<div style="
        width:14px;height:14px;border-radius:50%;
        background:${markerColor(state, isOffline)};
        opacity:${isOffline ? 0.5 : 1};
        border:2px solid white;"></div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });
  }

  function updateMarker(id, lat, lng, label, state, isOffline) {
    if (markers[id]) {
      markers[id]
        .setLatLng([lat, lng])
        .setIcon(getMarkerIcon(state, isOffline))
        .setPopupContent(label);
    } else {
      markers[id] = L.marker([lat, lng], {
        icon: getMarkerIcon(state, isOffline)
      })
        .addTo(map)
        .bindPopup(label);
    }
  }

  /* EVENT INIT */
  onValue(ref(db, `events/${eventId}`), async snap => {
    if (!snap.exists()) return;

    document.getElementById("eventName").textContent = snap.val().name;

    if (!osm) {
      osm = new OSMContext(eventId, { lat: 47.5, lng: 19.04 }, 5);
      await osm.init();
    }

    if (!pisteLayer) {
      pisteLayer = new PisteLayer(map, eventId, { lat: 47.5, lng: 19.04 }, 5);
    }
  });

  /* MEMBERS */
  onValue(ref(db, `members/${eventId}`), snap => {
    const list = document.getElementById("members");
    list.innerHTML = "";

    const now = Date.now();
    const members = snap.val() || {};

    Object.entries(members).forEach(([id, m]) => {
      const autoOffline = m.lastUpdate && now - m.lastUpdate > OFFLINE_TIMEOUT;
      const isOffline = m.manualState === "offline" || autoOffline;
      const state = m.activityState || "rest";

      let ctxName = "";
      if (!isOffline && osm && m.lat && m.lng) {
        const ctx = osm.getContext(m.lat, m.lng, state);
        if (ctx?.name) ctxName = ` ‚Äì ${ctx.name}`;
      }

      const label =
        isOffline ? "‚ö™ Offline" :
        state === "skiing" ? `üü¢ Cs√∫szik${ctxName}` :
        `üü° Pihen${ctxName}`;

      if (id === userId && m.lat && m.lng) {
        stats.addPoint({
          lat: m.lat,
          lng: m.lng,
          ts: Date.now(),
          state
        });
        renderStats();
      }

      const div = document.createElement("div");
      div.className = "member";
      div.innerHTML = `
        <div class="left">${label.split(" ")[0]} ${m.name || "?"}</div>
        <div class="time">${isOffline ? "offline" : timeAgo(m.lastUpdate)}</div>
      `;
      div.onclick = () => {
        if (m.lat && m.lng) {
          map.setView([m.lat, m.lng], 16, { animate: true });
          markers[id]?.openPopup();
        }
      };
      list.appendChild(div);

      if (m.lat && m.lng) {
        updateMarker(
          id,
          m.lat,
          m.lng,
          `<strong>${m.name}</strong><br>${label}`,
          state,
          isOffline
        );
      }
    });
  });

  function renderStats() {
    const s = stats.getStats();
    document.getElementById("stats").innerHTML =
      `üõ∑ T√°vols√°g: <strong>${s.distanceKm} km</strong><br>` +
      `‚òï Pihen≈ë: ${s.restTimeMin} perc`;
  }

  function timeAgo(ts) {
    if (!ts) return "";
    const min = Math.floor((Date.now() - ts) / 60000);
    if (min < 1) return "most";
    if (min === 1) return "1 perce";
    return `${min} perce`;
  }

  /* ACTIONS */
  window.goHome = () => location.href = "../index.html";

  window.setState = state =>
    update(ref(db, `members/${eventId}/${userId}`), {
      activityState: state,
      manualState: state === "offline" ? "offline" : null,
      lastUpdate: Date.now()
    });

  window.togglePistes = async () => {
    if (pisteLayer) await pisteLayer.toggle();
  };
</script>

</body>
</html>
