<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0e1116;
      --panel:#151a21;
      --panel-soft:rgba(21,26,33,.92);
      --text:#e6e9ef;
      --muted:#9aa4b2;
      --accent:#4da3ff;
      --green:#2ecc71;
      --blue:#3498db;
      --yellow:#f1c40f;
      --shadow:0 20px 50px rgba(0,0,0,.45);
      --r-lg:18px;
      --r-md:14px;
      --r-sm:10px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Inter",sans-serif;
    }

    #app{
      position:relative;
      width:100vw;
      height:100vh;
      overflow:hidden;
    }

    /* MAP */
    #map{
      position:absolute;
      inset:0;
      z-index:1;
    }

    #mapOverlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.15);
      pointer-events:none;
      z-index:2;
    }

    /* SIDEBAR */
    #sidebar{
      position:absolute;
      z-index:10;
      background:var(--panel-soft);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      transition:transform .35s ease, opacity .35s ease;
    }

    @media(min-width:769px){
      #sidebar{
        top:16px;left:16px;bottom:16px;
        width:320px;
        border-radius:var(--r-lg);
        padding:16px;
        overflow-y:auto;
        transform:translateY(8px);
        opacity:0;
        animation:panelIn .4s ease forwards;
      }
    }

    @media(max-width:768px){
      #sidebar{
        left:0;right:0;bottom:0;
        max-height:40vh;
        padding:12px 14px 18px;
        border-radius:var(--r-lg) var(--r-lg) 0 0;
        overflow-y:auto;
        transform:translateY(20px);
        opacity:0;
        animation:panelIn .45s ease forwards;
      }
      #sidebar::before{
        content:"";
        width:44px;height:4px;
        background:rgba(255,255,255,.25);
        border-radius:4px;
        margin:4px auto 10px;
        display:block;
      }
    }

    @keyframes panelIn{
      to{transform:translateY(0);opacity:1}
    }

    .section{margin-top:14px}
    .section strong{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }

    .btn{
      border:none;
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:12px;
      border-radius:var(--r-md);
      font-size:14px;
      cursor:pointer;
      width:100%;
      transition:background .15s, transform .1s;
    }

    .btn:hover{background:rgba(255,255,255,.14)}
    .btn:active{transform:scale(.97)}
    .btn.green{background:rgba(46,204,113,.2)}
    .btn.blue{background:rgba(52,152,219,.2)}
    .btn.yellow{background:rgba(241,196,15,.2)}

    .state-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }

    #members{
      display:grid;
      gap:8px;
    }

    @media(max-width:768px){
      #members{grid-template-columns:repeat(3,1fr)}
    }
    @media(min-width:769px){
      #members{grid-template-columns:1fr}
    }

    .member{
      background:rgba(255,255,255,.07);
      border-radius:var(--r-sm);
      padding:8px;
      cursor:pointer;
      transition:background .15s, opacity .15s;
    }

    .member:hover{background:rgba(255,255,255,.12)}
    .member.offline{opacity:.45}

    .member-name{
      font-size:13px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:4px;
    }

    .badge{
      background:var(--accent);
      font-size:10px;
      padding:1px 6px;
      border-radius:8px;
    }

    .member-state{
      font-size:11px;
      margin-top:4px;
      color:var(--muted);
    }

    .stats{
      background:rgba(255,255,255,.06);
      border-radius:var(--r-md);
      padding:10px;
      font-size:12px;
      margin-top:14px;
    }

    .stat-row{
      display:flex;
      justify-content:space-between;
      padding:3px 0;
      color:var(--muted);
    }

    .bottom-actions{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-top:14px;
    }

    .icon-btn{
      padding:12px 0;
      font-size:20px;
      text-align:center;
      border-radius:var(--r-md);
      background:rgba(255,255,255,.08);
      cursor:pointer;
      transition:background .15s, transform .1s;
    }

    .icon-btn:hover{background:rgba(255,255,255,.15)}
    .icon-btn:active{transform:scale(.95)}

    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:30;
    }

    .modal-content{
      background:var(--panel);
      padding:20px;
      border-radius:var(--r-lg);
      width:90%;
      max-width:360px;
      box-shadow:var(--shadow);
      max-height:80vh;
      overflow-y:auto;
    }

    .stat-card{
      background:rgba(255,255,255,.06);
      border-radius:var(--r-md);
      padding:10px;
      margin-bottom:10px;
      font-size:12px;
    }
  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>
  <div id="mapOverlay"></div>

  <div id="sidebar">

    <div class="section">
      <strong>Saj√°t √°llapot</strong>
      <div class="state-grid">
        <button class="btn green" onclick="setState('skiing')">üü¢ Cs√∫szok</button>
        <button class="btn blue" onclick="setState('lift')">üîµ Felvon√≥</button>
        <button class="btn yellow" onclick="setState('rest')">üü° Pihen</button>
        <button class="btn" onclick="setState('offline')">‚ö™ Offline</button>
      </div>
    </div>

    <div class="section">
      <strong>Tagok</strong>
      <div id="members"></div>
    </div>

    <div class="stats">
      <strong>Saj√°t stat</strong>
      <div class="stat-row"><span>‚è±Ô∏è Esem√©ny</span><span id="eventDuration">‚Äî</span></div>
      <div class="stat-row"><span>üü¢ Cs√∫sz√°s</span><span id="skiTime">0:00</span></div>
      <div class="stat-row"><span>üîµ Felvon√≥</span><span id="liftTime">0:00</span></div>
      <div class="stat-row"><span>üü° Pihen≈ë</span><span id="restTime">0:00</span></div>
      <div class="stat-row"><span>üìè Km</span><span id="distanceKm">0.00 km</span></div>
      <div class="stat-row"><span>‚ö° Max</span><span id="maxSpeed">‚Äî km/h</span></div>
    </div>

    <div class="bottom-actions">
      <div class="icon-btn" title="Vissza" onclick="goHome()">‚¨ÖÔ∏è</div>
      <div class="icon-btn" id="joinBtn" style="display:none" onclick="openJoin()">üîó</div>
      <div class="icon-btn" id="statBtn" style="display:none" onclick="openStat()">üìä</div>
    </div>

  </div>
</div>

<div class="modal" id="joinModal">
  <div class="modal-content">
    <h3>Csatlakoz√°s</h3>
    <div id="qr"></div>
    <div id="joinLink" style="font-size:12px;color:var(--muted)"></div>
    <button class="btn" onclick="copyJoin()">Link m√°sol√°sa</button>
    <button class="btn" style="margin-top:6px" onclick="closeJoin()">Bez√°r√°s</button>
  </div>
</div>

<div class="modal" id="statModal">
  <div class="modal-content">
    <h3>Tag statisztik√°k</h3>
    <div id="statList"></div>
    <button class="btn" onclick="closeStat()">Bez√°r√°s</button>
  </div>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const params = new URLSearchParams(location.search);
const eventId = params.get("eventId");

let userId = localStorage.getItem("userId");
let userName = localStorage.getItem("userName") || "Ismeretlen";

if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}

if (!eventId) {
  location.href = "../index.html";
}

  /* ================= MAP INIT ================= */
  const map=L.map("map");
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);

  let firstFix=true;
  let selfMarker=null;
  const markers={};

  /* ================= MARKER HELPERS ================= */
  function markerColor(state, offline){
    if(offline) return "#777";
    if(state==="skiing") return "#2ecc71";
    if(state==="lift") return "#3498db";
    if(state==="rest") return "#f1c40f";
    return "#ffffff";
  }

  function markerIcon(state, offline){
    return L.divIcon({
      className:"",
      html:`<div style="width:14px;height:14px;border-radius:50%;
        background:${markerColor(state,offline)};
        border:2px solid white;
        opacity:${offline?0.5:1};"></div>`,
      iconSize:[14,14],
      iconAnchor:[7,7]
    });
  }

  function updateMarker(id,lat,lng,label,state,offline){
    if(markers[id]){
      markers[id].setLatLng([lat,lng])
        .setIcon(markerIcon(state,offline))
        .setPopupContent(label);
    }else{
      markers[id]=L.marker([lat,lng],{
        icon:markerIcon(state,offline)
      }).addTo(map).bindPopup(label);
    }
  }

  /* ================= GPS ================= */
  navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    const now=Date.now();

    if(firstFix){
      map.setView([latitude,longitude],15,{animate:true});
      firstFix=false;
    }

    if(!selfMarker){
      selfMarker=L.marker([latitude,longitude]).addTo(map).bindPopup("Te itt vagy");
    }else{
      selfMarker.setLatLng([latitude,longitude]);
    }

    update(ref(db,`members/${eventId}/${userId}`),{
      name:userName,
      lat:latitude,
      lng:longitude,
      lastUpdate:now
    });
  });

  /* ================= MEMBERS + MARKERS ================= */
const OFFLINE_TIMEOUT = 15 * 60 * 1000;

onValue(ref(db, `members/${eventId}`), snap => {
  const list = document.getElementById("members");
  list.innerHTML = "";

  const data = snap.val() || {};
  const now = Date.now();

  Object.entries(data).forEach(([id, m]) => {
    if (!m.lat || !m.lng) return;

    const offline =
      m.manualState === "offline" ||
      (m.lastUpdate && now - m.lastUpdate > OFFLINE_TIMEOUT);

    const state = m.activityState || "rest";

    // üîπ MAP MARKER
    updateMarker(
      id,
      m.lat,
      m.lng,
      `<strong>${m.name || "?"}</strong>`,
      state,
      offline
    );

    // üîπ SIDEBAR TAG
    const div = document.createElement("div");
    div.className = "member" + (offline ? " offline" : "");

    div.innerHTML = `
      <div class="member-name">${m.name || "?"}</div>
      <div class="member-state">
        ${offline ? "‚ö™ Offline" : state}
      </div>
    `;

    div.onclick = () => {
      map.setView([m.lat, m.lng], 16, { animate: true });
      markers[id]?.openPopup();
    };

    list.appendChild(div);
  });
});


  /* ================= STATE ================= */
  window.setState=state=>{
    update(ref(db,`members/${eventId}/${userId}`),{
      activityState:state,
      manualState:state==="offline"?"offline":null,
      lastUpdate:Date.now()
    });
  };

  window.goHome=()=>location.href="../index.html";
  /* ================= OWNER ACTIONS ================= */
onValue(ref(db, `events/${eventId}`), snap => {
  if (!snap.exists()) return;

  const event = snap.val();

  if (event.ownerId === userId) {
    const joinBtn = document.getElementById("joinBtn");
    const statBtn = document.getElementById("statBtn");

    if (joinBtn) joinBtn.style.display = "block";
    if (statBtn) statBtn.style.display = "block";
  }
});
/* ================= JOIN MODAL ================= */
window.openJoin = () => {
  const qrEl = document.getElementById("qr");
  const linkEl = document.getElementById("joinLink");
  const modal = document.getElementById("joinModal");

  qrEl.innerHTML = "";

  const link = `${location.origin}/user/map.html?eventId=${eventId}`;
  linkEl.textContent = link;

  new QRCode(qrEl, {
    text: link,
    width: 180,
    height: 180,
    colorDark: "#ffffff",
    colorLight: "transparent"
  });

  modal.style.display = "flex";
};

window.closeJoin = () => {
  document.getElementById("joinModal").style.display = "none";
};

window.copyJoin = () => {
  const link = document.getElementById("joinLink").textContent;
  navigator.clipboard.writeText(link);
  alert("Link m√°solva");
};
/* ================= STAT MODAL ================= */
window.openStat = () => {
  const list = document.getElementById("statList");
  const modal = document.getElementById("statModal");

  list.innerHTML = "";

  Object.entries(userStats).forEach(([uid, s]) => {
    const div = document.createElement("div");
    div.className = "stat-card";
    div.innerHTML = `
      <strong>${s.name || uid}</strong><br>
      üü¢ Cs√∫sz√°s: ${(s.skiMs / 60000).toFixed(0)} perc<br>
      üîµ Lift: ${(s.liftMs / 60000).toFixed(0)} perc<br>
      üü° Pihen≈ë: ${(s.restMs / 60000).toFixed(0)} perc<br>
      üìè Km: ${s.distanceKm.toFixed(2)} km<br>
      ‚ö° Max: ${s.maxSpeed.toFixed(1)} km/h
    `;
    list.appendChild(div);
  });

  modal.style.display = "flex";
};

window.closeStat = () => {
  document.getElementById("statModal").style.display = "none";
};

</script>
</body>
</html>
