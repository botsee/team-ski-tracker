<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Inter",sans-serif;
      background:#0e1116;
      color:#e6e9ef;
    }
    button{ font-family:inherit; }

    header{
      padding:14px 16px;
      background:#151a21;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header strong{ font-size:16px; }

    #dashboardView{ padding:16px; }

    .primary-btn{
      width:100%;
      padding:16px;
      font-size:18px;
      border:none;
      border-radius:14px;
      background:#4da3ff;
      color:white;
      cursor:pointer;
      margin-bottom:16px;
    }

    .state-box{
      background:rgba(255,255,255,.08);
      padding:12px;
      border-radius:12px;
      margin-bottom:16px;
      font-size:14px;
    }

    /* ===== ACTIVITY BADGE ===== */
    .activity{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
      margin-top:6px;
    }
    .activity.skiing{ background:#1abc9c; color:#042f26; }
    .activity.lift  { background:#3498db; color:#041f33; }
    .activity.rest  { background:#f1c40f; color:#3a2f04; }
    .activity.idle  { background:#7f8c8d; color:#1f2a2b; }

    .section-title{
      font-size:13px;
      color:#9aa4b2;
      margin:18px 0 8px;
    }

    #members{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }

    .member{
      background:rgba(255,255,255,.08);
      padding:10px;
      border-radius:10px;
      font-size:12px;
      text-align:center;
      cursor:pointer;
    }
    .member.offline{ opacity:.4; }

    .bottom-actions{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }

    .icon-btn{
      padding:14px 0;
      background:rgba(255,255,255,.1);
      border-radius:12px;
      text-align:center;
      font-size:18px;
      cursor:pointer;
    }

    #mapView{
      display:none;
      height:100vh;
      width:100vw;
      position:relative;
    }
    #map{ height:100%; width:100%; }

    #closeMap{
      position:absolute;
      top:14px;
      left:14px;
      z-index:1000;
      background:#151a21;
      color:white;
      border:none;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
    }
    #debugToggleBtn{
  position:relative;
  z-index:4000;
}
.event-meta{
  font-size:12px;
  color:#9aa4b2;
  margin-bottom:10px;
}

.mini-map-wrapper{
  position:relative;
  height:22vh;
  margin:14px 0;
  border-radius:14px;
  overflow:hidden;
  cursor:pointer;
}

#miniMap{
  height:100%;
  width:100%;
}

.mini-map-overlay{
  position:absolute;
  inset:0;
  background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding-bottom:10px;
  font-size:13px;
  color:#fff;
  pointer-events:none;
}

.state-actions{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-bottom:16px;
}

.state-actions button{
  padding:10px;
  border:none;
  border-radius:10px;
  background:rgba(255,255,255,.08);
  color:#e6e9ef;
}

  </style>
</head>

<body>

<header>
  <strong>Esem√©ny</strong>
</header>

<!-- ===== EVENT META ===== -->
<div class="event-meta">
  <div id="eventInfo">
    Esem√©ny ¬∑ S√≠t√©r ¬∑ 09:00‚Äì16:30 ¬∑ 0/0 akt√≠v
  </div>
</div>

<!-- ===== START / STATE ===== -->
<button class="primary-btn" id="startBtn">‚ñ∂Ô∏è M√©r√©s ind√≠t√°sa</button>

<div class="state-box">
  Saj√°t √°llapot: <strong id="activityLabel">‚Äî</strong>
</div>

<!-- ===== MINI MAP ===== -->
<div class="mini-map-wrapper" onclick="showMap()">
  <div id="miniMap"></div>
  <div class="mini-map-overlay">üó∫Ô∏è T√©rk√©p nagy√≠t√°sa</div>
</div>

<!-- ===== MANUAL STATE (HELYK√âSZEN) ===== -->
<div class="section-title">√Ållapot v√°lt√°s</div>
<div class="state-actions">
  <button>ü§ñ Auto</button>
  <button>üõë Pihen≈ë</button>
  <button>‚ö´ Offline</button>
</div>

<!-- ===== MEMBERS ===== -->
<div class="section-title">Tagok</div>
<div id="members"></div>

<!-- ===== ACTIONS ===== -->
<div class="bottom-actions">
  <div class="icon-btn" onclick="showMap()">üó∫Ô∏è</div>
  <div class="icon-btn" onclick="openStat()">üìä</div>
  <div class="icon-btn">üîó</div>
  <div class="icon-btn" onclick="goHome()">‚¨ÖÔ∏è</div>
</div>


<div id="mapView">
  <button id="closeMap" onclick="showDashboard()">‚¨ÖÔ∏è Vissza</button>
  <div id="map"></div>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const mapView = document.getElementById("mapView");

  window.showMap = () => {
    document.body.style.overflow = "hidden";
    mapView.style.display = "block";
    window._mapInstance?.invalidateSize();
  };
  
  window.showDashboard = () => {
  mapView.style.display = "none";
  dashboardView.style.display = "block";

  setTimeout(() => {
    if (window._miniMap) {
      window._miniMap.invalidateSize();
    }
  }, 50);
};
  window.goHome = () => location.href = "../index.html";

  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");
  if (!eventId) {
    alert("Hi√°nyz√≥ esem√©ny azonos√≠t√≥");
    location.href = "../index.html";
  }
  let debugEnabled = true;

  /* ================= MEASUREMENT ================= */
  let measurementActive = false;

  const startBtn = document.getElementById("startBtn");

  startBtn.onclick = () => {
    measurementActive = !measurementActive;
    startBtn.textContent = measurementActive
      ? "‚èπÔ∏è M√©r√©s le√°ll√≠t√°sa"
      : "‚ñ∂Ô∏è M√©r√©s ind√≠t√°sa";
    startBtn.style.background = measurementActive ? "#e74c3c" : "#4da3ff";
  };

  /* ================= ACTIVITY STATE ================= */
  let currentActivity = "idle";
  let candidateActivity = null;
  let candidateSince = null;
  let lastActivityChange = Date.now();

  const STATE_CONFIRM_TIME = 8000;

  function updateActivityUI(state){
    const el = document.getElementById("activityLabel");
    if (!el) return;

    const map = {
      skiing: "üü¢ Cs√∫sz√°s",
      lift:   "üîµ Felvon√≥",
      rest:   "üü° Pihen≈ë",
      idle:   "‚ö™ K√©szenl√©t"
    };

    el.textContent = map[state] || "‚Äî";
  }

  /* ================= STATS ================= */
  let skiingMs = 0, liftMs = 0, restMs = 0;
  let totalDistanceKm = 0, maxSpeedKmh = 0;
  let lastGpsPoint = null;
  let lastAltitude = null;
  let currentTrack = null;
let lastTrackState = null;


  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function updateDebug({ state, candidate, speedKmh, deltaAlt }) {
    if (!debugEnabled) return;

    const now = Date.now();
    const confirmSec = candidateSince
      ? Math.max(0, Math.floor((now - candidateSince) / 1000))
      : 0;

    const dbgState = document.getElementById("dbgState");
    const dbgCand = document.getElementById("dbgCand");
    const dbgSpeed = document.getElementById("dbgSpeed");
    const dbgAlt = document.getElementById("dbgAlt");
    const dbgConfirm = document.getElementById("dbgConfirm");

    if (dbgState) dbgState.textContent = state;
    if (dbgCand) dbgCand.textContent = candidate || "‚Äî";
    if (dbgSpeed) dbgSpeed.textContent =
      speedKmh != null ? speedKmh.toFixed(1) : "‚Äî";
    if (dbgAlt) dbgAlt.textContent =
      deltaAlt != null ? deltaAlt.toFixed(1) : "‚Äî";
    if (dbgConfirm) dbgConfirm.textContent = confirmSec;
  }

  function detectCandidateState({ speedKmh, deltaAlt }) {
    if (!measurementActive) return "idle";
    if (speedKmh <= 1.5) return "rest";
    if (speedKmh >= 5 && (deltaAlt == null || deltaAlt <= 0)) return "skiing";
    if (speedKmh > 1.5 && speedKmh <= 6 && deltaAlt > 0) return "lift";
    return currentActivity;
  }

  function updateActivityState(candidate) {
    const now = Date.now();

    if (candidate !== candidateActivity) {
      candidateActivity = candidate;
      candidateSince = now;
      return;
    }

    if (
      candidate !== currentActivity &&
      now - candidateSince >= STATE_CONFIRM_TIME
    ) {
      const delta = now - lastActivityChange;

      if (measurementActive) {
        if (currentActivity === "skiing") skiingMs += delta;
        if (currentActivity === "lift") liftMs += delta;
        if (currentActivity === "rest") restMs += delta;
      }

      currentActivity = candidate;
      lastActivityChange = now;
      updateActivityUI(candidate);
    }
  }
function getTrackColor(state) {
  if (state === "skiing") return "#1abc9c"; // z√∂ld
  if (state === "lift")   return "#3498db"; // k√©k
  if (state === "rest")   return "#f1c40f"; // s√°rga
  return "#7f8c8d"; // idle / egy√©b
}

  /* ===== AUTH + MAP ===== */
  const auth = getAuth();
  let userId = null;
  let userName = localStorage.getItem("userName") || "Ismeretlen";

  onAuthStateChanged(auth, user => {
    if (user) {
      userId = user.uid;
      initMapApp();
    } else {
      signInAnonymously(auth);
    }
  });

  function initMapApp() {
    const map = L.map("map");
    window._mapInstance = map;
    // ===== MINI MAP INIT (ELS≈ê BET√ñLT√âSKOR) =====
const miniMap = L.map("miniMap", {
  zoomControl: false,
  attributionControl: false,
  dragging: false,
  scrollWheelZoom: false,
  doubleClickZoom: false
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18
}).addTo(miniMap);

// glob√°lis referencia k√©s≈ëbbre
window._miniMap = miniMap;


    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    // ===== MINI MAP =====
    window._miniMap = L.map("miniMap", {
      zoomControl: false,
      attributionControl: false,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18
    }).addTo(window._miniMap);

    const markerIcon = color =>
      L.divIcon({
        className:"",
        html:`<div style="width:14px;height:14px;border-radius:50%;background:${color};border:2px solid white;"></div>`,
        iconSize:[14,14], iconAnchor:[7,7]
      });

    let firstFix = true;
    let selfMarker = null;
    let miniMapMarker = null;

    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude, altitude, speed } = pos.coords;
      const speedKmh = speed ? speed * 3.6 : 0;
      const deltaAlt = lastAltitude != null && altitude != null
        ? altitude - lastAltitude
        : null;

      if (firstFix) {
        map.setView([latitude, longitude], 15);
        window._miniMap.setView([latitude, longitude], 14);
        firstFix = false;
      }
      window._miniMap.setView([latitude, longitude]);


      if (!selfMarker) {
        selfMarker = L.marker([latitude, longitude], {
          icon: markerIcon("#2ecc71")
        }).addTo(map);
      } else {
        selfMarker.setLatLng([latitude, longitude]);
      }

      if (!miniMapMarker) {
        miniMapMarker = L.marker([latitude, longitude], {
          icon: markerIcon("#2ecc71")
        }).addTo(window._miniMap);
      } else {
        miniMapMarker.setLatLng([latitude, longitude]);
        window._miniMap.setView([latitude, longitude], 14);
      }

      const candidate = detectCandidateState({ speedKmh, deltaAlt });
      // ===== TRACK DRAW =====
if (measurementActive) {
  if (currentActivity !== lastTrackState) {
    // √∫j szakasz √°llapotv√°lt√°skor
    currentTrack = L.polyline([], {
      color: getTrackColor(currentActivity),
      weight: 4,
      opacity: 0.9
    }).addTo(map);

    lastTrackState = currentActivity;
  }

  if (currentTrack) {
    currentTrack.addLatLng([latitude, longitude]);
  }
}

      updateActivityState(candidate);
      updateDebug({
        state: currentActivity,
        candidate,
        speedKmh,
        deltaAlt
      });

      if (measurementActive && currentActivity === "skiing" && lastGpsPoint) {
        const dKm = haversine(
          lastGpsPoint.lat,
          lastGpsPoint.lng,
          latitude,
          longitude
        );
        totalDistanceKm += dKm;
        maxSpeedKmh = Math.max(maxSpeedKmh, speedKmh);
      }

      lastGpsPoint = { lat: latitude, lng: longitude };
      lastAltitude = altitude;

      update(ref(db, `members/${eventId}/${userId}`), {
        name: userName,
        lat: latitude,
        lng: longitude,
        lastUpdate: Date.now()
      });
    }, err => console.warn(err), { enableHighAccuracy:true });
  }

  window.openStat = () => alert(
    `üü¢ Cs√∫sz√°s: ${Math.round(skiingMs/60000)} perc\n` +
    `üîµ Felvon√≥: ${Math.round(liftMs/60000)} perc\n` +
    `üü° Pihen≈ë: ${Math.round(restMs/60000)} perc`
  );

  window.toggleDebug = () => {
    debugEnabled = !debugEnabled;

    const el = document.getElementById("debugOverlay");
    if (el) {
      el.style.display = debugEnabled ? "block" : "none";
    }

    console.log("DEBUG:", debugEnabled);
  };

</script>
<div id="debugOverlay" style="
  position:fixed;
  bottom:12px;
  right:12px;
  background:rgba(0,0,0,.75);
  color:#e6e9ef;
  font-size:12px;
  padding:10px 12px;
  border-radius:12px;
  line-height:1.4;
  z-index:3000;
  pointer-events:none;

">
  <div><strong>DEBUG</strong></div>
  <div>state: <span id="dbgState">‚Äî</span></div>
  <div>candidate: <span id="dbgCand">‚Äî</span></div>
  <div>speed: <span id="dbgSpeed">‚Äî</span> km/h</div>
  <div>Œîalt: <span id="dbgAlt">‚Äî</span> m</div>
  <div>confirm: <span id="dbgConfirm">‚Äî</span> s</div>
</div>

</body>
</html>
