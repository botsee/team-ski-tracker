<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Team Ski Tracker – Esemény</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,sans-serif;
      background:#0e1116;
      color:#e6e9ef;
    }

    header{
      padding:12px 16px;
      background:#151a21;
    }

    .event-meta{
      font-size:12px;
      opacity:.7;
      margin-top:4px;
    }

    .mini-map-wrapper{
      height:22vh;
      margin:12px;
      border-radius:14px;
      overflow:hidden;
      cursor:pointer;
    }

    #miniMap{ height:100%; width:100%; }

    #mapView{
      display:none;
      position:fixed;
      inset:0;
      background:#000;
      z-index:1000;
    }

    #map{ height:100%; width:100%; }

    #closeMap{
      position:absolute;
      top:12px;
      left:12px;
      z-index:1100;
      padding:8px 12px;
      border:none;
      border-radius:10px;
      background:#151a21;
      color:white;
    }

    .members{
      padding:12px;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }

    .member{
      background:rgba(255,255,255,.08);
      padding:8px;
      border-radius:10px;
      font-size:12px;
      text-align:center;
    }

    .member.offline{ opacity:.4; }
  </style>
</head>

<body>

<header>
  <div><strong id="eventName">Esemény</strong></div>
  <div class="event-meta" id="eventMeta">—</div>
</header>

<div class="mini-map-wrapper" onclick="openMap()">
  <div id="miniMap"></div>
</div>

<div class="members" id="members"></div>

<div id="mapView">
  <button id="closeMap" onclick="closeMap()">⬅️ Vissza</button>
  <div id="map"></div>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  /* ===== PARAMS ===== */
  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");
  if (!eventId) {
    alert("Hiányzó esemény");
    location.href = "../index.html";
  }

  /* ===== MAP VARS ===== */
  let map, miniMap;
  let selfMarker = null;
  let miniMarker = null;
  let memberMarkers = {};
  let firstFix = true;

  /* ===== VIEW ===== */
  window.openMap = () => {
    document.getElementById("mapView").style.display = "block";
    setTimeout(() => map.invalidateSize(), 100);
  };
  window.closeMap = () => {
    document.getElementById("mapView").style.display = "none";
    setTimeout(() => miniMap.invalidateSize(), 100);
  };

  /* ===== AUTH ===== */
  const auth = getAuth();
  let userId = null;
  let userName = localStorage.getItem("userName") || "Ismeretlen";

  onAuthStateChanged(auth, user => {
    if (user) {
      userId = user.uid;
      initMaps();
      startGps();
      loadEvent();
      subscribeMembers();
    } else {
      signInAnonymously(auth);
    }
  });

  /* ===== EVENT META ===== */
  function loadEvent() {
    onValue(ref(db, `events/${eventId}`), snap => {
      const e = snap.val();
      if (!e) return;
      document.getElementById("eventName").textContent = e.name || "Esemény";
      document.getElementById("eventMeta").textContent =
        `${e.resort || "—"} · ${e.startTime || ""}–${e.endTime || ""}`;
    });
  }

  /* ===== MAP INIT ===== */
  function initMaps() {
    map = L.map("map");
    miniMap = L.map("miniMap", {
      zoomControl:false,
      attributionControl:false,
      dragging:false,
      scrollWheelZoom:false
    });

    const tiles = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    L.tileLayer(tiles,{maxZoom:18}).addTo(map);
    L.tileLayer(tiles,{maxZoom:18}).addTo(miniMap);
  }

  /* ===== GPS ===== */
  function startGps() {
    navigator.geolocation.watchPosition(
      pos => {
        const { latitude, longitude } = pos.coords;
        const now = Date.now();

        if (!selfMarker) {
          selfMarker = L.marker([latitude, longitude]).addTo(map).bindPopup("Te");
          miniMarker = L.marker([latitude, longitude]).addTo(miniMap);
          map.setView([latitude, longitude], 15);
          miniMap.setView([latitude, longitude], 14);
        } else {
          selfMarker.setLatLng([latitude, longitude]);
          miniMarker.setLatLng([latitude, longitude]);
        }

        update(ref(db, `members/${eventId}/${userId}`), {
          name: userName,
          lat: latitude,
          lng: longitude,
          lastUpdate: now
        });
      },
      err => alert("GPS hiba: " + err.message),
      { enableHighAccuracy:true }
    );
  }

  /* ===== MEMBERS ===== */
  function subscribeMembers() {
    const OFFLINE = 15*60*1000;

    onValue(ref(db, `members/${eventId}`), snap => {
      const list = document.getElementById("members");
      list.innerHTML = "";

      const now = Date.now();
      const data = snap.val() || {};

      Object.entries(data).forEach(([id,m]) => {
        if (!m.lat || !m.lng) return;

        if (!memberMarkers[id]) {
          memberMarkers[id] = L.marker([m.lat, m.lng]).addTo(map);
        } else {
          memberMarkers[id].setLatLng([m.lat, m.lng]);
        }

        const offline = !m.lastUpdate || now - m.lastUpdate > OFFLINE;
        const div = document.createElement("div");
        div.className = "member" + (offline ? " offline" : "");
        div.textContent = m.name || "?";

        div.onclick = () => {
          openMap();
          map.setView([m.lat, m.lng], 16);
        };

        list.appendChild(div);
      });
    });
  }
</script>

</body>
</html>
