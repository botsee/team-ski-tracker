<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --bg:#0e1116;
      --panel:#151a21;
      --panel-soft:rgba(21,26,33,.92);
      --text:#e6e9ef;
      --muted:#9aa4b2;
      --accent:#4da3ff;

      --green:#2ecc71;
      --blue:#3498db;
      --yellow:#f1c40f;

      --r-lg:18px;
      --r-md:14px;
      --r-sm:10px;

      --shadow:0 20px 50px rgba(0,0,0,.45);
    }

    * { box-sizing:border-box }

    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Inter",sans-serif;
    }

    #app {
      position:relative;
      width:100vw;
      height:100vh;
      overflow:hidden;
    }

    #map {
      position:absolute;
      inset:0;
      z-index:0;
    }

    #map::after {
      content:"";
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.2);
      pointer-events:none;
      z-index:1;
    }

    #sidebar {
      position:absolute;
      z-index:10;
      background:var(--panel-soft);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }

    @media(min-width:769px){
      #sidebar{
        top:16px; left:16px; bottom:16px;
        width:320px;
        border-radius:var(--r-lg);
        padding:16px;
        overflow-y:auto;
      }
    }

    @media(max-width:768px){
      #sidebar{
        left:0; right:0; bottom:0;
        max-height:40vh;
        padding:12px 14px 18px;
        border-radius:var(--r-lg) var(--r-lg) 0 0;
        overflow-y:auto;
      }
      #sidebar::before{
        content:"";
        width:44px; height:4px;
        background:rgba(255,255,255,.25);
        border-radius:4px;
        margin:4px auto 10px;
        display:block;
      }
    }

    .section { margin-top:14px }
    .section strong {
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }

    .btn {
      border:none;
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:12px;
      border-radius:var(--r-md);
      font-size:14px;
      cursor:pointer;
      width:100%;
    }

    .btn.icon {
      padding:10px;
      font-size:18px;
    }

    .btn.green { background:rgba(46,204,113,.18) }
    .btn.blue  { background:rgba(52,152,219,.18) }
    .btn.yellow{ background:rgba(241,196,15,.18) }

    .state-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }

    #members {
      display:grid;
      gap:8px;
    }

    @media(max-width:768px){
      #members{ grid-template-columns:repeat(3,1fr) }
    }
    @media(min-width:769px){
      #members{ grid-template-columns:1fr }
    }

    .member {
      background:rgba(255,255,255,.07);
      border-radius:var(--r-sm);
      padding:8px;
      cursor:pointer;
    }

    .member.offline { opacity:.55 }

    .member-name { font-size:13px; font-weight:600 }
    .member-state{ font-size:11px; margin-top:4px }
    .time { font-size:10px; color:var(--muted) }

    .badge {
      background:rgba(0,0,0,.35);
      font-size:10px;
      padding:1px 5px;
      border-radius:8px;
      margin-left:4px;
    }

    .stats {
      background:rgba(255,255,255,.06);
      border-radius:var(--r-md);
      padding:10px;
      font-size:12px;
      margin-top:14px;
    }

    .stat-row {
      display:flex;
      justify-content:space-between;
      padding:3px 0;
      color:var(--muted);
    }

    /* MODAL (JOIN + STAT) */
    .modal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:30;
    }

    .modal-content {
      background:var(--panel);
      padding:20px;
      border-radius:var(--r-lg);
      width:90%;
      max-width:360px;
      box-shadow:var(--shadow);
      max-height:80vh;
      overflow-y:auto;
    }

    .modal h3 {
      margin-top:0;
      margin-bottom:10px;
    }

    #qr { margin:14px auto }

    .link {
      font-size:12px;
      word-break:break-all;
      color:var(--muted);
      margin-top:10px;
    }

    .stat-card {
      background:rgba(255,255,255,.06);
      border-radius:var(--r-md);
      padding:10px;
      margin-bottom:10px;
      font-size:12px;
    }

    .stat-card strong {
      display:block;
      margin-bottom:6px;
    }
  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <div id="sidebar">

    <div class="section">
      <strong>Saj√°t √°llapot</strong>
      <div class="state-grid">
        <button class="btn green" onclick="setState('skiing')">üü¢ Cs√∫szok</button>
        <button class="btn blue" onclick="setState('lift')">üîµ Felvon√≥</button>
        <button class="btn yellow" onclick="setState('rest')">üü° Pihen</button>
        <button class="btn" onclick="setState('offline')">‚ö™ Offline</button>
      </div>
    </div>

    <div class="section">
      <strong>Tagok</strong>
      <div id="members"></div>
    </div>

    <div class="stats">
      <strong>Saj√°t stat</strong>
      <div class="stat-row"><span>‚è±Ô∏è Esem√©ny</span><span id="eventDuration">‚Äî</span></div>
      <div class="stat-row"><span>üü¢ Cs√∫sz√°s</span><span id="skiTime">0:00</span></div>
      <div class="stat-row"><span>üîµ Felvon√≥</span><span id="liftTime">0:00</span></div>
      <div class="stat-row"><span>üü° Pihen≈ë</span><span id="restTime">0:00</span></div>
      <div class="stat-row"><span>üìè Km</span><span id="distanceKm">0.00 km</span></div>
      <div class="stat-row"><span>‚ö° Max</span><span id="maxSpeed">‚Äî km/h</span></div>
    </div>

    <div class="section">
      <button class="btn icon" title="Vissza a f≈ëoldalra" onclick="goHome()">‚¨ÖÔ∏è</button>
      <button class="btn icon" id="joinBtn" style="margin-top:8px;display:none" onclick="openJoin()">üîó</button>
      <button class="btn icon" id="statBtn" style="margin-top:8px;display:none" onclick="openStat()">üìä</button>
    </div>

  </div>
</div>

<!-- JOIN MODAL -->
<div class="modal" id="joinModal">
  <div class="modal-content">
    <h3>Csatlakoz√°s</h3>
    <div id="qr"></div>
    <div class="link" id="joinLink"></div>
    <button class="btn" style="margin-top:10px" onclick="copyJoin()">Link m√°sol√°sa</button>
    <button class="btn" style="margin-top:6px" onclick="closeJoin()">Bez√°r√°s</button>
  </div>
</div>

<!-- OWNER STAT MODAL -->
<div class="modal" id="statModal">
  <div class="modal-content">
    <h3>Tag statisztik√°k</h3>
    <div id="statList"></div>
    <button class="btn" style="margin-top:10px" onclick="closeStat()">Bez√°r√°s</button>
  </div>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, onValue, update } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");
  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName") || "Ismeretlen";

  if (!eventId || !userId) location.href = "../index.html";

  let isOwner = false;
  let joinLink = "";
  let memberStats = {};

  const fmt = ms => {
    const m = Math.floor(ms / 60000);
    const h = Math.floor(m / 60);
    return `${h}:${(m % 60).toString().padStart(2,"0")}`;
  };

  onValue(ref(db, `events/${eventId}`), snap => {
    if (!snap.exists()) return;
    const e = snap.val();
    isOwner = e.ownerId === userId;
    if (isOwner) {
      document.getElementById("joinBtn").style.display = "block";
      document.getElementById("statBtn").style.display = "block";
      joinLink = `${location.origin}/user/map.html?eventId=${eventId}`;
    }
    if (e.createdAt) {
      setInterval(() => {
        eventDuration.textContent = fmt(Date.now() - e.createdAt);
      }, 60000);
    }
  });

  /* OWNER STAT ‚Äì csak gy≈±jt√©s √©s render */
  onValue(ref(db, `members/${eventId}`), snap => {
    const data = snap.val() || {};
    memberStats = {};
    Object.entries(data).forEach(([uid, m]) => {
      memberStats[uid] = {
        name: m.name || "?",
        ski: m.skiMs || 0,
        lift: m.liftMs || 0,
        rest: m.restMs || 0,
        km: m.distanceKm || 0,
        max: m.maxSpeed || 0
      };
    });
  });

  window.openStat = () => {
    const list = document.getElementById("statList");
    list.innerHTML = "";
    Object.values(memberStats).forEach(s => {
      const div = document.createElement("div");
      div.className = "stat-card";
      div.innerHTML = `
        <strong>${s.name}</strong>
        üü¢ Cs√∫sz√°s: ${fmt(s.ski)}<br/>
        üîµ Felvon√≥: ${fmt(s.lift)}<br/>
        üü° Pihen≈ë: ${fmt(s.rest)}<br/>
        üìè Km: ${s.km.toFixed(2)}<br/>
        ‚ö° Max: ${s.max.toFixed(1)} km/h
      `;
      list.appendChild(div);
    });
    document.getElementById("statModal").style.display = "flex";
  };

  window.closeStat = () =>
    document.getElementById("statModal").style.display = "none";

  window.goHome = () => location.href = "../index.html";

  window.openJoin = () => {
    document.getElementById("joinLink").textContent = joinLink;
    document.getElementById("qr").innerHTML = "";
    new QRCode(document.getElementById("qr"), {
      text: joinLink,
      width: 180,
      height: 180,
      colorDark: "#ffffff",
      colorLight: "transparent"
    });
    document.getElementById("joinModal").style.display = "flex";
  };

  window.closeJoin = () =>
    document.getElementById("joinModal").style.display = "none";

  window.copyJoin = () => {
    navigator.clipboard.writeText(joinLink);
    alert("Link m√°solva");
  };
</script>
</body>
</html>
