<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Team Ski Tracker ‚Äì Admin</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1f6f8b">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f4f7fa;
    }
    header {
      background: #1f6f8b;
      color: white;
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
    }
    main {
      max-width: 1000px;
      margin: auto;
      padding: 16px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #1f6f8b;
      color: white;
      border: none;
    }
    #map {
      height: 400px;
      border-radius: 12px;
    }
  </style>
</head>

<body>

<header>Team Ski Tracker ‚Äì Admin</header>

<main>

<div class="card">
  <h2>√öj esem√©ny</h2>
  <input id="eventName" placeholder="Esem√©ny neve">
  <input id="skiResortName" placeholder="S√≠t√©r neve">
  <input id="fromDate" type="datetime-local">
  <input id="toDate" type="datetime-local">

  <select id="eventStatus">
    <option value="planned">Tervezett</option>
    <option value="active">Akt√≠v</option>
    <option value="finished">Lez√°rt</option>
  </select>

  <button id="createEventBtn">Esem√©ny l√©trehoz√°sa</button>
  <p id="createStatus"></p>
</div>

<div class="card">
  <h2>Esem√©nyek</h2>
  <ul id="eventList"></ul>
</div>

<div class="card">
  <h2>Csatlakoz√°s</h2>
  <a id="joinLink" target="_blank"></a>
  <div id="qr"></div>
</div>

<div class="card">
  <h2>T√©rk√©p</h2>
  <div id="map"></div>
</div>

</main>

<script type="module">
  import { db } from "./js/config.js";
  import { ref, push, set, onValue } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  let selectedEventId = null;
  let map = null;
  let markers = {};

  const eventList = document.getElementById("eventList");
  const joinLink = document.getElementById("joinLink");
  const qrDiv = document.getElementById("qr");

  // üî¥ EZ A KRITIKUS R√âSZ ‚Äì HELYES BASE PATH
  function getBasePath() {
    return window.location.origin +
           window.location.pathname.replace(/index\.html$/, "");
  }

  document.getElementById("createEventBtn").onclick = async () => {
    const newEventRef = push(ref(db, "events"));
    await set(newEventRef, {
      name: eventName.value,
      skiResortName: skiResortName.value,
      from: fromDate.value,
      to: toDate.value,
      status: eventStatus.value,
      createdAt: Date.now()
    });
  };

  onValue(ref(db, "events"), snap => {
    eventList.innerHTML = "";
    const events = snap.val() || {};

    Object.entries(events).forEach(([id, e]) => {
      const li = document.createElement("li");
      li.textContent = `${e.name} (${e.status})`;
      li.onclick = () => selectEvent(id);
      eventList.appendChild(li);
    });
  });

  function selectEvent(eventId) {
    selectedEventId = eventId;

    const joinUrl =
      `${getBasePath()}join.html?eventId=${eventId}`;

    joinLink.href = joinUrl;
    joinLink.textContent = joinUrl;

    qrDiv.innerHTML = "";
    new QRCode(qrDiv, joinUrl);
  }
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>

</body>
</html>
