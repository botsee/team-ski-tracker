<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Team Ski Tracker – Admin</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1f6f8b">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f4f7fa;
    }
    header {
      background: #1f6f8b;
      color: white;
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
    }
    main {
      max-width: 1000px;
      margin: auto;
      padding: 16px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #1f6f8b;
      color: white;
      border: none;
    }
    #map {
      height: 400px;
      border-radius: 12px;
    }
  </style>
</head>

<body>

<header>Team Ski Tracker – Admin</header>

<main>

<div class="card">
  <h2>Új esemény</h2>
  <input id="eventName" placeholder="Esemény neve">
  <input id="skiResortName" placeholder="Sítér neve">
  <input id="fromDate" type="datetime-local">
  <input id="toDate" type="datetime-local">

  <select id="eventStatus">
    <option value="planned">Tervezett</option>
    <option value="active">Aktív</option>
    <option value="finished">Lezárt</option>
  </select>

  <button id="createEventBtn">Esemény létrehozása</button>
</div>

<div class="card">
  <h2>Események</h2>
  <ul id="eventList"></ul>
</div>

<div class="card">
  <h2>Csatlakozás</h2>
  <a id="joinLink" target="_blank"></a>
  <div id="qr"></div>
</div>

<div class="card">
  <h2>Térkép</h2>
  <div id="map"></div>
</div>

</main>

<script type="module">
  import { db } from "./js/config.js";
  import { ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  let selectedEventId = null;
  let map;
  let markers = {};

  createEventBtn.onclick = async () => {
    const newEventRef = push(ref(db, "events"));
    await set(newEventRef, {
      name: eventName.value,
      skiResortName: skiResortName.value,
      from: fromDate.value,
      to: toDate.value,
      status: eventStatus.value,
      createdAt: Date.now()
    });
  };

  onValue(ref(db, "events"), snap => {
    eventList.innerHTML = "";
    Object.entries(snap.val() || {}).forEach(([id, e]) => {
      const li = document.createElement("li");
      li.textContent = e.name;
      li.onclick = () => selectEvent(id);
      eventList.appendChild(li);
    });
  });

  function selectEvent(id) {
    selectedEventId = id;
    const url = `${location.origin}/join.html?eventId=${id}`;
    joinLink.href = url;
    joinLink.textContent = url;
    qr.innerHTML = "";
    new QRCode(qr, url);
    initMap();
    listenMembers();
  }

  function initMap() {
    if (map) return;
    map = L.map("map").setView([47.3, 13.3], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }

  function listenMembers() {
    onValue(ref(db, `events/${selectedEventId}/members`), snap => {
      Object.entries(snap.val() || {}).forEach(([id, m]) => {
        if (!m.location) return;
        if (!markers[id]) {
          markers[id] = L.marker([m.location.lat, m.location.lng])
            .addTo(map)
            .bindPopup(m.displayName);
        } else {
          markers[id].setLatLng([m.location.lat, m.location.lng]);
        }
      });
    });
  }
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>

</body>
</html>
