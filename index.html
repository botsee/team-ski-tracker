<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Team Ski Tracker ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1f6f8b">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Distortable Image -->
  <link
    rel="stylesheet"
    href="lib/leaflet-distortableimage/leaflet.distortableimage.css">
  <script
    src="lib/leaflet-distortableimage/leaflet.distortableimage.js"></script>

  <!-- QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f4f7fa;
    }
    header {
      background: #1f6f8b;
      color: white;
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
    }
    main {
      max-width: 1200px;
      margin: auto;
      padding: 16px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      background: #1f6f8b;
      color: white;
      border: none;
      cursor: pointer;
    }
    ul {
      padding-left: 18px;
    }
    li {
      cursor: pointer;
      margin-bottom: 6px;
    }
    #map {
      height: 520px;
      border-radius: 12px;
    }
    .small {
      font-size: 13px;
      color: #555;
    }
  </style>
</head>

<body>

<header>Team Ski Tracker ‚Äì Admin</header>

<main>

<div class="card">
  <h2>Esem√©nyek</h2>
  <ul id="eventList"></ul>
</div>

<div class="card">
  <h2>Csatlakoz√°s</h2>
  <a id="joinLink" target="_blank"></a>
  <div id="qr"></div>
</div>

<div class="card">
  <h2>S√≠t√©rk√©p felt√∂lt√©s (h√∫zd a t√©rk√©pre)</h2>
  <input type="file" id="imageInput" accept="image/*">
  <button id="saveSkiMapBtn">S√≠t√©rk√©p ment√©se</button>
  <p class="small">
    Felt√∂lt√©s ut√°n h√∫zd, m√©retezd √©s forgasd a t√©rk√©pen, majd mentsd.
  </p>
</div>

<div class="card">
  <h2>T√©rk√©p</h2>
  <div id="map"></div>
</div>

</main>

<script type="module">
  import { db } from "./js/config.js";
  import {
    ref,
    onValue,
    update
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const eventList = document.getElementById("eventList");
  const joinLink = document.getElementById("joinLink");
  const qrDiv = document.getElementById("qr");
  const imageInput = document.getElementById("imageInput");
  const saveBtn = document.getElementById("saveSkiMapBtn");

  let selectedEventId = null;
  let map;
  let overlay = null;

  // üó∫Ô∏è MAP INIT
  map = L.map("map").setView([47.3, 13.3], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
    .addTo(map);

  // üìã EVENT LIST
  onValue(ref(db, "events"), snap => {
    eventList.innerHTML = "";
    const events = snap.val() || {};

    Object.entries(events).forEach(([id, e]) => {
      const li = document.createElement("li");
      li.textContent = e.name || id;
      li.onclick = () => selectEvent(id);
      eventList.appendChild(li);
    });
  });

  function selectEvent(eventId) {
    selectedEventId = eventId;

    const joinUrl =
      "https://botsee.github.io/team-ski-tracker/join.html?eventId=" + eventId;

    joinLink.href = joinUrl;
    joinLink.textContent = joinUrl;

    qrDiv.innerHTML = "";
    new QRCode(qrDiv, joinUrl);

    // bet√∂ltj√ºk, ha van m√°r s√≠t√©rk√©p
    onValue(ref(db, `events/${eventId}/skiMap`), snap => {
      const skiMap = snap.val();
      if (skiMap && skiMap.imageUrl && skiMap.corners) {
        if (overlay) map.removeLayer(overlay);

        overlay = L.distortableImageOverlay(skiMap.imageUrl, {
          corners: [
            skiMap.corners.topLeft,
            skiMap.corners.topRight,
            skiMap.corners.bottomRight,
            skiMap.corners.bottomLeft
          ],
          actions: [
            L.DistortableImage.Edit,
            L.DistortableImage.Rotate,
            L.DistortableImage.Scale
          ]
        }).addTo(map);
      }
    });
  }

  // üì§ IMAGE UPLOAD (LOCAL PREVIEW)
  imageInput.onchange = e => {
    if (!selectedEventId) {
      alert("El≈ëbb v√°lassz esem√©nyt.");
      imageInput.value = "";
      return;
    }

    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      if (overlay) map.removeLayer(overlay);

      overlay = L.distortableImageOverlay(reader.result, {
        actions: [
          L.DistortableImage.Edit,
          L.DistortableImage.Rotate,
          L.DistortableImage.Scale
        ]
      }).addTo(map);
    };
    reader.readAsDataURL(file);
  };

  // üíæ SAVE SKI MAP
  saveBtn.onclick = async () => {
    if (!overlay || !selectedEventId) {
      alert("Nincs mit menteni.");
      return;
    }

    const corners = overlay.getCorners();

    await update(ref(db, `events/${selectedEventId}/skiMap`), {
      imageUrl: overlay._url,
      corners: {
        topLeft: corners[0],
        topRight: corners[1],
        bottomRight: corners[2],
        bottomLeft: corners[3]
      }
    });

    alert("S√≠t√©rk√©p elmentve.");
  };
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
</script>

</body>
</html>
