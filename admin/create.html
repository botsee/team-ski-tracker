<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>√öj esem√©ny ‚Äì Team Ski Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- QR lib (lightweight) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --bg:#0e1116;
      --panel:#151a21;
      --panel-soft:rgba(21,26,33,.92);
      --text:#e6e9ef;
      --muted:#9aa4b2;
      --accent:#4da3ff;
      --r-lg:18px;
      --r-md:14px;
      --shadow:0 20px 50px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,"Inter",sans-serif;
    }

    header{
      position:sticky;
      top:0;
      background:var(--panel-soft);
      backdrop-filter:blur(10px);
      padding:14px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      z-index:5;
    }

    header .left{
      display:flex;
      align-items:center;
      gap:10px;
    }

    header button{
      border:none;
      background:rgba(255,255,255,.12);
      color:var(--text);
      padding:8px 12px;
      border-radius:var(--r-md);
      cursor:pointer;
      font-size:14px;
    }

    main{
      padding:20px 16px;
      max-width:480px;
      margin:auto;
    }

    .card{
      background:rgba(255,255,255,.06);
      border-radius:var(--r-lg);
      padding:18px 16px 20px;
      box-shadow:var(--shadow);
    }

    label{
      display:block;
      margin-top:14px;
      font-size:13px;
      color:var(--muted);
    }

    input,select{
      width:100%;
      margin-top:6px;
      padding:12px;
      font-size:15px;
      border-radius:var(--r-md);
      border:none;
      background:rgba(255,255,255,.08);
      color:var(--text);
    }

    #createBtn{
      margin-top:22px;
      width:100%;
      padding:14px;
      font-size:16px;
      border-radius:var(--r-md);
      border:none;
      background:var(--accent);
      color:white;
      cursor:pointer;
    }

    #createBtn:disabled{
      opacity:.5;
    }

    /* JOIN MODAL */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
    }

    .modal-content{
      background:var(--panel);
      padding:20px;
      border-radius:var(--r-lg);
      width:90%;
      max-width:320px;
      text-align:center;
      box-shadow:var(--shadow);
    }

    #qr{
      margin:14px auto;
    }

    .link{
      font-size:12px;
      word-break:break-all;
      color:var(--muted);
      margin-top:10px;
    }

    .copy{
      margin-top:12px;
      width:100%;
      padding:10px;
      border:none;
      border-radius:var(--r-md);
      background:rgba(255,255,255,.12);
      color:var(--text);
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>
  <div class="left">
    <button onclick="location.href='../index.html'">‚¨ÖÔ∏è</button>
    <strong>√öj esem√©ny</strong>
  </div>
  <button id="joinBtn" onclick="openJoin()" disabled>üîó</button>
</header>

<main>
  <div class="card">
    <label>
      Esem√©ny neve
      <input id="name" placeholder="Pl. H√©tv√©gi s√≠el√©s" />
    </label>

    <label>
      S√≠t√©r
      <select id="resort">
        <option value="">‚Äì v√°lassz s√≠terepet ‚Äì</option>
      </select>
    </label>

    <label>
      Kezd√©s
      <input id="startAt" type="datetime-local" />
    </label>

    <label>
      Befejez√©s
      <input id="endAt" type="datetime-local" />
    </label>

    <button id="createBtn">Esem√©ny l√©trehoz√°sa</button>
  </div>
</main>

<!-- JOIN MODAL -->
<div class="modal" id="joinModal">
  <div class="modal-content">
    <strong>Csatlakoz√°s</strong>
    <div id="qr"></div>
    <div class="link" id="joinLink"></div>
    <button class="copy" onclick="copyLink()">Link m√°sol√°sa</button>
    <button class="copy" onclick="closeJoin()">Bez√°r√°s</button>
  </div>
</div>

<script type="module">
  import { db } from "../js/config.js";
  import { ref, push, set } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { skiResorts } from "../js/skiResorts.js";

  const userId = localStorage.getItem("userId");
  const userName = localStorage.getItem("userName") || "Ismeretlen";

  if (!userId) location.href="../index.html";

  const resortSelect=document.getElementById("resort");
  const btn=document.getElementById("createBtn");
  const joinBtn=document.getElementById("joinBtn");

  let createdEventId=null;

  Object.values(skiResorts).forEach(r=>{
    const o=document.createElement("option");
    o.value=r.id;
    o.textContent=`${r.name} (${r.country})`;
    resortSelect.appendChild(o);
  });

  btn.onclick=async()=>{
    const name=nameInput.value.trim();
    const resortId=resortSelect.value;
    const startAt=startAtInput.value;
    const endAt=endAtInput.value;

    if(!name||!resortId||!startAt||!endAt){
      alert("Minden mez≈ë k√∂telez≈ë");return;
    }
    if(startAt>=endAt){
      alert("Befejez√©s nem lehet kor√°bbi");return;
    }

    btn.disabled=true;

    const eventRef=push(ref(db,"events"));
    createdEventId=eventRef.key;

    await set(eventRef,{
      name,
      resortId,
      ownerId:userId,
      ownerName:userName,
      startAt,
      endAt,
      status:"active",
      createdAt:Date.now()
    });

    await set(ref(db,`members/${createdEventId}/${userId}`),{
      name:userName,
      role:"host",
      joinedAt:Date.now()
    });

    joinBtn.disabled=false;
    generateJoin();
  };

  window.openJoin=()=>document.getElementById("joinModal").style.display="flex";
  window.closeJoin=()=>document.getElementById("joinModal").style.display="none";

  function generateJoin(){
    const link=`${location.origin}/user/map.html?eventId=${createdEventId}`;
    document.getElementById("joinLink").textContent=link;
    document.getElementById("qr").innerHTML="";
    new QRCode(document.getElementById("qr"),{
      text:link,
      width:180,
      height:180,
      colorDark:"#ffffff",
      colorLight:"transparent"
    });
  }

  window.copyLink=()=>{
    navigator.clipboard.writeText(document.getElementById("joinLink").textContent);
    alert("Link m√°solva");
  };
</script>

</body>
</html>
